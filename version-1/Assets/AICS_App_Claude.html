<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AICS App - Learn Better AI Collaboration</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--gray-800);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.95;
            max-width: 600px;
            margin: 0 auto;
        }

        .content {
            padding: 40px;
        }

        /* Upload Section */
        .upload-section {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px dashed var(--gray-300);
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.02);
        }

        .upload-section h2 {
            color: var(--gray-800);
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .file-input:hover {
            border-color: var(--primary);
        }

        .divider {
            text-align: center;
            margin: 25px 0;
            color: var(--gray-500);
            font-weight: 600;
            position: relative;
        }

        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--gray-300);
            z-index: 1;
        }

        .divider span {
            background: var(--gray-50);
            padding: 0 20px;
            position: relative;
            z-index: 2;
        }

        textarea {
            width: 100%;
            min-height: 180px;
            padding: 20px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            background: white;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .analyze-btn {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(37, 99, 235, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Light Report */
        .light-report {
            background: var(--gray-50);
            border-radius: 12px;
            padding: 30px;
            margin: 30px 0;
            border-left: 4px solid var(--primary);
        }

        .light-report h2 {
            color: var(--gray-800);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-500);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
        }

        .classification-card {
            background: linear-gradient(135deg, var(--success) 0%, #0d9488 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin: 20px 0;
        }

        .classification-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }

        .classification-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .classification-desc {
            font-size: 16px;
            opacity: 0.95;
        }

        /* Email Gate */
        .email-gate {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 35px;
            border-radius: 12px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
        }

        .email-gate h3 {
            font-size: 26px;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .email-gate p {
            margin-bottom: 25px;
            font-size: 18px;
            opacity: 0.95;
        }

        .email-form {
            display: flex;
            gap: 12px;
            max-width: 450px;
            margin: 0 auto;
        }

        .email-input {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
        }

        .unlock-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 15px 25px;
            border: 2px solid white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .unlock-btn:hover {
            background: white;
            color: #4CAF50;
        }

        .preview-blur {
            filter: blur(4px);
            user-select: none;
            opacity: 0.6;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 8px;
        }

        /* Full Report */
        .full-report {
            background: white;
            border-radius: 12px;
            padding: 35px;
            margin: 30px 0;
            border: 2px solid var(--gray-200);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .full-report h2 {
            color: var(--gray-800);
            margin-bottom: 30px;
            text-align: center;
            font-size: 2rem;
        }

        .shape-breakdown {
            margin-bottom: 35px;
        }

        .shape-breakdown h3 {
            color: var(--gray-800);
            margin-bottom: 20px;
            font-size: 1.4rem;
        }

        .shape-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--gray-200);
        }

        .shape-item:last-child {
            border-bottom: none;
        }

        .shape-label {
            font-weight: 600;
            color: var(--gray-700);
            flex: 1;
        }

        .shape-description {
            font-size: 14px;
            color: var(--gray-500);
            flex: 2;
            margin: 0 20px;
        }

        .shape-score {
            font-weight: 700;
            color: var(--primary);
            font-size: 20px;
            min-width: 60px;
            text-align: center;
        }

        .total-score {
            background: var(--primary);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .total-score-value {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 5px;
        }

        .total-score-label {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Recommendations */
        .recommendations {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 30px;
            border-radius: 12px;
            border-left: 4px solid var(--warning);
            margin-top: 30px;
        }

        .recommendations h3 {
            color: var(--gray-800);
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .rec-section {
            margin-bottom: 25px;
        }

        .rec-section h4 {
            color: var(--gray-700);
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .rec-list {
            list-style: none;
            padding: 0;
        }

        .rec-list li {
            background: white;
            padding: 15px;
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .progress-path {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin-top: 25px;
            text-align: center;
        }

        .progress-path h4 {
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .hidden {
            display: none;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #dc2626;
        }

        @media (max-width: 768px) {
            .email-form {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .shape-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .shape-description {
                margin: 0;
            }

            .container {
                margin: 10px;
                border-radius: 12px;
            }

            .content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù AICS App</h1>
            <p class="subtitle">Learn to collaborate better with AI. Analyze your chat transcripts and get personalized improvement strategies.</p>
        </div>

        <div class="content">
            <div class="upload-section">
                <h2>üìù Upload Your Chat Transcript</h2>
                <p style="color: var(--gray-600); margin-bottom: 20px;">Upload a file or paste your complete conversation with ChatGPT, Claude, or any AI assistant.</p>
                
                <div class="form-group">
                    <label for="fileInput">Upload transcript file (.txt, .docx)</label>
                    <input type="file" id="fileInput" class="file-input" accept=".txt,.docx">
                </div>

                <div class="divider"><span>OR</span></div>

                <div class="form-group">
                    <label for="transcriptText">Paste your transcript</label>
                    <textarea id="transcriptText" placeholder="Paste your chat transcript here...

Example format:
User: Can you help me write a blog post about sustainable living?
Assistant: I'd be happy to help you write a blog post about sustainable living...
User: That's great, but can you make it more focused on practical tips?
Assistant: Absolutely! Here's a revised version with more practical tips..."></textarea>
                </div>

                <div class="form-group">
                    <label for="countrySelect">Country where the session took place</label>
                    <select id="countrySelect">
                        <option value="">Select country...</option>
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                        <option value="GB">United Kingdom</option>
                        <option value="AU">Australia</option>
                        <option value="DE">Germany</option>
                        <option value="FR">France</option>
                        <option value="ES">Spain</option>
                        <option value="IT">Italy</option>
                        <option value="NL">Netherlands</option>
                        <option value="SE">Sweden</option>
                        <option value="NO">Norway</option>
                        <option value="DK">Denmark</option>
                        <option value="FI">Finland</option>
                        <option value="JP">Japan</option>
                        <option value="KR">South Korea</option>
                        <option value="CN">China</option>
                        <option value="IN">India</option>
                        <option value="SG">Singapore</option>
                        <option value="BR">Brazil</option>
                        <option value="MX">Mexico</option>
                        <option value="AR">Argentina</option>
                        <option value="CL">Chile</option>
                        <option value="ZA">South Africa</option>
                        <option value="NG">Nigeria</option>
                        <option value="EG">Egypt</option>
                        <option value="IL">Israel</option>
                        <option value="AE">United Arab Emirates</option>
                        <option value="SA">Saudi Arabia</option>
                        <option value="TR">Turkey</option>
                        <option value="RU">Russia</option>
                        <option value="PL">Poland</option>
                        <option value="CZ">Czech Republic</option>
                        <option value="HU">Hungary</option>
                        <option value="GR">Greece</option>
                        <option value="PT">Portugal</option>
                        <option value="IE">Ireland</option>
                        <option value="BE">Belgium</option>
                        <option value="CH">Switzerland</option>
                        <option value="AT">Austria</option>
                        <option value="OTHER">Other</option>
                    </select>
                </div>

                <button class="analyze-btn" onclick="analyzeSession()">
                    üîç Analyze My Collaboration
                </button>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message hidden"></div>

            <!-- Light Report -->
            <div id="lightReport" class="light-report hidden">
                <h2>üìä Your Collaboration Snapshot</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Total Exchanges</div>
                        <div class="stat-value" id="totalTurns">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Your Messages</div>
                        <div class="stat-value" id="userTurns">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AI Messages</div>
                        <div class="stat-value" id="aiTurns">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">AI Word Share</div>
                        <div class="stat-value" id="aiWordShare">-</div>
                    </div>
                </div>

                <div class="classification-card">
                    <div class="classification-title">Your AI Use Classification</div>
                    <div class="classification-value" id="classification">-</div>
                    <div class="classification-desc" id="classificationDesc">-</div>
                </div>

                <div id="sessionInfo" style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <p><strong>Session Language:</strong> <span id="sessionLanguage">-</span></p>
                    <p><strong>Session Country:</strong> <span id="sessionCountry">-</span></p>
                    <p><strong>Session Purpose:</strong> <span id="sessionPurpose">-</span></p>
                </div>
            </div>

            <!-- Email Gate -->
            <div id="emailGate" class="email-gate hidden">
                <h3>üöÄ Unlock Your Learning Path</h3>
                <p>Get your detailed SHAPE analysis and personalized strategies to improve your AI collaboration skills.</p>
                
                <div class="preview-blur">
                    <h4>SHAPE Skills Breakdown Preview:</h4>
                    <p><strong>Structural Vision (S):</strong> ?/5 - How well you guide structure and direction</p>
                    <p><strong>Human-Led Meaning (H):</strong> ?/5 - How much you interpret and add context</p>
                    <p><strong>Authorial Voice (A):</strong> ?/5 - How well you maintain your unique style</p>
                    <p><strong>Purpose Framing (P):</strong> ?/5 - How clearly you define goals and audience</p>
                    <p><strong>Editorial Intervention (E):</strong> ?/5 - How actively you refine and improve outputs</p>
                </div>

                <div class="email-form">
                    <input type="email" class="email-input" id="emailInput" placeholder="your.email@example.com" required>
                    <button class="unlock-btn" onclick="unlockFullReport()">Get My Analysis</button>
                </div>
            </div>

            <!-- Full Report -->
            <div id="fullReport" class="full-report hidden">
                <h2>üéØ Your Complete AICS Analysis</h2>
                
                <div class="shape-breakdown">
                    <h3>SHAPE Collaboration Skills Breakdown</h3>
                    <div class="shape-item">
                        <div class="shape-label">Structural Vision (S)</div>
                        <div class="shape-description">How well you guide the overall structure and direction</div>
                        <div class="shape-score" id="structuralScore">?/5</div>
                    </div>
                    <div class="shape-item">
                        <div class="shape-label">Human-Led Meaning (H)</div>
                        <div class="shape-description">How much you interpret and add context to AI responses</div>
                        <div class="shape-score" id="humanMeaningScore">?/5</div>
                    </div>
                    <div class="shape-item">
                        <div class="shape-label">Authorial Voice (A)</div>
                        <div class="shape-description">How well you maintain your unique style and perspective</div>
                        <div class="shape-score" id="authorialScore">?/5</div>
                    </div>
                    <div class="shape-item">
                        <div class="shape-label">Purpose Framing (P)</div>
                        <div class="shape-description">How clearly you define goals, audience, and expected outcomes</div>
                        <div class="shape-score" id="purposeScore">?/5</div>
                    </div>
                    <div class="shape-item">
                        <div class="shape-label">Editorial Intervention (E)</div>
                        <div class="shape-description">How actively you refine, critique, and improve AI output</div>
                        <div class="shape-score" id="editorialScore">?/5</div>
                    </div>
                </div>

                <div class="total-score">
                    <div class="total-score-value" id="totalScore">?/25</div>
                    <div class="total-score-label">Total SHAPE Score</div>
                </div>

                <div class="recommendations">
                    <h3>üí° Your Personalized Learning Path</h3>
                    
                    <div class="rec-section">
                        <h4>üéØ What You're Doing Well</h4>
                        <p id="strengths">-</p>
                    </div>

                    <div class="rec-section">
                        <h4>üìà Key Growth Opportunities</h4>
                        <ul class="rec-list" id="opportunities">
                        </ul>
                    </div>

                    <div class="rec-section">
                        <h4>üõ†Ô∏è Specific Techniques to Try</h4>
                        <ul class="rec-list" id="tactics">
                        </ul>
                    </div>

                    <div class="progress-path">
                        <h4>üéØ Focus for Your Next AI Session</h4>
                        <p id="nextFocus">-</p>
                    </div>
                </div>

                <div style="background: var(--gray-100); padding: 20px; border-radius: 8px; margin-top: 30px; border-left: 4px solid var(--warning);">
                    <h4 style="color: var(--gray-800); margin-bottom: 10px;">üìã Important Note About AICS Citations</h4>
                    <p style="color: var(--gray-600);">This educational report analyzes your collaboration <strong>process</strong>. For academic or professional work requiring formal attribution, <strong>AICS Pro</strong> analyzes the <strong>final product</strong> using Levenshtein distance analysis and generates official citations.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentAnalysis = null;

        // AI Use Classifications with descriptions
        const classifications = {
            "Tool": "You use AI as a basic tool for simple tasks",
            "Assistant": "You direct AI to create content based on your requests", 
            "Augmentor": "You actively collaborate and refine AI outputs",
            "Cocreator": "You and AI work as true creative partners"
        };

        // Countries for display
        const countries = {
            "US": "United States", "CA": "Canada", "GB": "United Kingdom", "AU": "Australia",
            "DE": "Germany", "FR": "France", "ES": "Spain", "IT": "Italy", "NL": "Netherlands",
            "SE": "Sweden", "NO": "Norway", "DK": "Denmark", "FI": "Finland", "JP": "Japan",
            "KR": "South Korea", "CN": "China", "IN": "India", "SG": "Singapore", "BR": "Brazil",
            "MX": "Mexico", "AR": "Argentina", "CL": "Chile", "ZA": "South Africa", "NG": "Nigeria",
            "EG": "Egypt", "IL": "Israel", "AE": "United Arab Emirates", "SA": "Saudi Arabia",
            "TR": "Turkey", "RU": "Russia", "PL": "Poland", "CZ": "Czech Republic", "HU": "Hungary",
            "GR": "Greece", "PT": "Portugal", "IE": "Ireland", "BE": "Belgium", "CH": "Switzerland",
            "AT": "Austria", "OTHER": "Other"
        };

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        function analyzeSession() {
            const fileInput = document.getElementById('fileInput');
            const transcript = document.getElementById('transcriptText').value;
            const country = document.getElementById('countrySelect').value;

            // Validation
            if (!transcript.trim() && !fileInput.files.length) {
                showError('Please provide a transcript either by pasting text or uploading a file.');
                return;
            }

            if (!country) {
                showError('Please select the country where the session took place.');
                return;
            }

            // Hide any previous results
            document.getElementById('lightReport').classList.add('hidden');
            document.getElementById('emailGate').classList.add('hidden');
            document.getElementById('fullReport').classList.add('hidden');

            // Handle file upload or pasted text
            if (fileInput.files.length > 0) {
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    processTranscript(e.target.result, country);
                };
                
                reader.onerror = function() {
                    showError('Error reading file. Please try again.');
                };
                
                reader.readAsText(file);
            } else {
                processTranscript(transcript, country);
            }
        }

        function processTranscript(transcript, country) {
            try {
                // Process the transcript
                currentAnalysis = analyzeTranscript(transcript, country);

                if (!currentAnalysis) {
                    showError('Could not analyze the transcript. Please check the format and try again.');
                    return;
                }

                // Show the light report
                displayLightReport(currentAnalysis);
                
                // Show email gate
                document.getElementById('emailGate').classList.remove('hidden');
                
                // Scroll to results
                document.getElementById('lightReport').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                showError('Error analyzing transcript: ' + error.message);
            }
        }

        function analyzeTranscript(transcript, country) {
            // Parse the transcript into messages
            const messages = parseMessages(transcript);
            
            if (messages.length === 0) {
                return null;
            }
            
            // Analyze collaboration patterns
            return analyzeCollaboration(messages, country);
        }

        function parseMessages(transcript) {
            const lines = transcript.split('\n').filter(line => line.trim());
            const messages = [];
            let currentRole = null;
            let currentContent = [];

            for (const line of lines) {
                const trimmed = line.trim();
                if (!trimmed) continue;

                // Detect role changes
                const userPatterns = ['user:', 'human:', 'you:', 'me:', 'you said:'];
                const aiPatterns = ['assistant:', 'ai:', 'chatgpt:', 'claude:', 'gpt:', 'bot:', 'chatgpt said:'];
                
                let roleFound = false;
                
                // Check for user message
                for (const pattern of userPatterns) {
                    if (trimmed.toLowerCase().startsWith(pattern)) {
                        if (currentRole && currentContent.length > 0) {
                            messages.push({
                                role: currentRole,
                                content: currentContent.join('\n').trim()
                            });
                        }
                        currentRole = 'user';
                        currentContent = [trimmed.substring(pattern.length).trim()];
                        roleFound = true;
                        break;
                    }
                }
                
                // Check for AI message
                if (!roleFound) {
                    for (const pattern of aiPatterns) {
                        if (trimmed.toLowerCase().startsWith(pattern)) {
                            if (currentRole && currentContent.length > 0) {
                                messages.push({
                                    role: currentRole,
                                    content: currentContent.join('\n').trim()
                                });
                            }
                            currentRole = 'assistant';
                            currentContent = [trimmed.substring(pattern.length).trim()];
                            roleFound = true;
                            break;
                        }
                    }
                }
                
                // If no role indicator, add to current content
                if (!roleFound && currentRole) {
                    currentContent.push(trimmed);
                } else if (!roleFound) {
                    // First message without indicator - assume user
                    currentRole = 'user';
                    currentContent = [trimmed];
                }
            }

            // Don't forget the last message
            if (currentRole && currentContent.length > 0) {
                messages.push({
                    role: currentRole,
                    content: currentContent.join('\n').trim()
                });
            }

            return messages.filter(msg => msg.content.length > 0);
        }

        function analyzeCollaboration(messages, country) {
            if (messages.length === 0) {
                return null;
            }

            const userMessages = messages.filter(m => m.role === 'user');
            const aiMessages = messages.filter(m => m.role === 'assistant');
            
            // Calculate word counts
            const userWords = userMessages.reduce((sum, m) => sum + m.content.split(/\s+/).length, 0);
            const aiWords = aiMessages.reduce((sum, m) => sum + m.content.split(/\s+/).length, 0);
            const totalWords = userWords + aiWords;
            
            // Detect language (simple detection)
            const fullText = messages.map(m => m.content).join(' ');
            const language = detectLanguage(fullText);
            
            // Detect session purpose
            const purpose = detectSessionPurpose(userMessages);
            
            // Analyze SHAPE scores
            const shapeScores = calculateSHAPEScores(userMessages);
            const totalShape = Object.values(shapeScores).reduce((sum, score) => sum + score, 0);
            
            // Determine classification based on SHAPE score
            let classification;
            if (totalShape <= 10) classification = "Tool";
            else if (totalShape <= 17) classification = "Assistant";
            else if (totalShape <= 22) classification = "Augmentor";
            else classification = "Cocreator";

            return {
                totalTurns: messages.length,
                userTurns: userMessages.length,
                aiTurns: aiMessages.length,
                aiWordShare: Math.round((aiWords / totalWords) * 100),
                classification: classification,
                shapeScores: shapeScores,
                totalShape: totalShape,
                userMessages: userMessages,
                language: language,
                country: country,
                purpose: purpose
            };
        }

        function detectLanguage(text) {
            // Simple language detection based on common words
            const sampleText = text.toLowerCase().substring(0, 500);
            
            const englishWords = ['the', 'and', 'you', 'that', 'was', 'for', 'are', 'with', 'his', 'they'];
            const spanishWords = ['que', 'de', 'no', 'la', 'el', 'en', 'un', 'es', 'se', 'te'];
            const frenchWords = ['que', 'de', 'et', 'le', 'la', 'les', 'un', 'une', 'ce', 'se'];
            const germanWords = ['der', 'die', 'und', 'in', 'den', 'von', 'zu', 'das', 'mit', 'sich'];
            
            let englishCount = englishWords.filter(word => sampleText.includes(' ' + word + ' ')).length;
            let spanishCount = spanishWords.filter(word => sampleText.includes(' ' + word + ' ')).length;
            let frenchCount = frenchWords.filter(word => sampleText.includes(' ' + word + ' ')).length;
            let germanCount = germanWords.filter(word => sampleText.includes(' ' + word + ' ')).length;
            
            if (englishCount >= spanishCount && englishCount >= frenchCount && englishCount >= germanCount) {
                return 'English';
            } else if (spanishCount >= frenchCount && spanishCount >= germanCount) {
                return 'Spanish';
            } else if (frenchCount >= germanCount) {
                return 'French';
            } else if (germanCount > 0) {
                return 'German';
            }
            
            return 'English'; // Default
        }

        function detectSessionPurpose(userMessages) {
            const allContent = userMessages.map(m => m.content.toLowerCase()).join(' ');
            
            if (allContent.includes('write') || allContent.includes('create') || allContent.includes('draft')) {
                if (allContent.includes('email') || allContent.includes('letter')) return 'Email/Letter Writing';
                if (allContent.includes('blog') || allContent.includes('article')) return 'Content Creation';
                if (allContent.includes('plan') || allContent.includes('strategy')) return 'Planning & Strategy';
                return 'Writing & Creation';
            }
            
            if (allContent.includes('analyze') || allContent.includes('explain') || allContent.includes('summarize')) {
                return 'Analysis & Research';
            }
            
            if (allContent.includes('brainstorm') || allContent.includes('ideas') || allContent.includes('creative')) {
                return 'Brainstorming & Ideation';
            }
            
            if (allContent.includes('code') || allContent.includes('program') || allContent.includes('debug')) {
                return 'Programming & Technical';
            }
            
            if (allContent.includes('learn') || allContent.includes('teach') || allContent.includes('explain')) {
                return 'Learning & Education';
            }
            
            return 'General Assistance';
        }

        function calculateSHAPEScores(userMessages) {
            if (userMessages.length === 0) {
                return { structural: 0, humanMeaning: 0, authorial: 0, purpose: 0, editorial: 0 };
            }

            const scores = {
                structural: 0,
                humanMeaning: 0,
                authorial: 0,
                purpose: 0,
                editorial: 0
            };

            // Enhanced keyword analysis with frequency counting
            userMessages.forEach(msg => {
                const content = msg.content.toLowerCase();
                
                // Structural Vision indicators (0-5 based on frequency and quality)
                let structuralIndicators = 0;
                if (content.includes('outline') || content.includes('structure')) structuralIndicators += 2;
                if (content.includes('organize') || content.includes('format')) structuralIndicators += 1;
                if (content.includes('section') || content.includes('chapter')) structuralIndicators += 1;
                if (content.includes('reorganize') || content.includes('restructure')) structuralIndicators += 2;
                scores.structural += Math.min(2, structuralIndicators);
                
                // Human-Led Meaning indicators
                let meaningIndicators = 0;
                if (content.includes('context') || content.includes('background')) meaningIndicators += 2;
                if (content.includes('meaning') || content.includes('interpret')) meaningIndicators += 2;
                if (content.includes('clarify') || content.includes('explain')) meaningIndicators += 1;
                if (content.includes('nuance') || content.includes('subtle')) meaningIndicators += 1;
                scores.humanMeaning += Math.min(2, meaningIndicators);
                
                // Authorial Voice indicators
                let voiceIndicators = 0;
                if (content.includes('my style') || content.includes('my voice')) voiceIndicators += 2;
                if (content.includes('tone') || content.includes('style')) voiceIndicators += 1;
                if (content.includes('sound like') || content.includes('write like')) voiceIndicators += 1;
                if (content.includes('personal') || content.includes('unique')) voiceIndicators += 1;
                scores.authorial += Math.min(2, voiceIndicators);
                
                // Purpose Framing indicators
                let purposeIndicators = 0;
                if (content.includes('audience') || content.includes('reader')) purposeIndicators += 2;
                if (content.includes('purpose') || content.includes('goal')) purposeIndicators += 2;
                if (content.includes('objective') || content.includes('target')) purposeIndicators += 1;
                if (content.includes('specific') || content.includes('particular')) purposeIndicators += 1;
                scores.purpose += Math.min(2, purposeIndicators);
                
                // Editorial Intervention indicators
                let editorialIndicators = 0;
                if (content.includes('revise') || content.includes('improve')) editorialIndicators += 2;
                if (content.includes('change') || content.includes('edit')) editorialIndicators += 1;
                if (content.includes('add') || content.includes('include')) editorialIndicators += 1;
                if (content.includes('critique') || content.includes('feedback')) editorialIndicators += 1;
                scores.editorial += Math.min(2, editorialIndicators);
            });

            // Normalize to 0-5 scale and consider message complexity
            const messageCount = userMessages.length;
            const complexityBonus = messageCount >= 3 ? 1 : 0; // Bonus for longer conversations
            
            Object.keys(scores).forEach(key => {
                scores[key] = Math.min(5, Math.max(0, scores[key] + complexityBonus));
            });

            return scores;
        }

        function displayLightReport(analysis) {
            if (!analysis) return;

            document.getElementById('totalTurns').textContent = analysis.totalTurns;
            document.getElementById('userTurns').textContent = analysis.userTurns;
            document.getElementById('aiTurns').textContent = analysis.aiTurns;
            document.getElementById('aiWordShare').textContent = analysis.aiWordShare + '%';
            document.getElementById('classification').textContent = analysis.classification;
            document.getElementById('classificationDesc').textContent = classifications[analysis.classification];
            
            // Session info
            document.getElementById('sessionLanguage').textContent = analysis.language;
            document.getElementById('sessionCountry').textContent = countries[analysis.country] || analysis.country;
            document.getElementById('sessionPurpose').textContent = analysis.purpose;
            
            document.getElementById('lightReport').classList.remove('hidden');
        }

        function unlockFullReport() {
            const email = document.getElementById('emailInput').value;
            
            if (!email || !email.includes('@')) {
                showError('Please enter a valid email address.');
                return;
            }

            // Simulate email collection (in real app, this would send to your backend)
            console.log('Email collected:', email);

            // Hide email gate
            document.getElementById('emailGate').classList.add('hidden');
            
            // Show full report
            displayFullReport(currentAnalysis);
            
            // Scroll to full report
            document.getElementById('fullReport').scrollIntoView({ behavior: 'smooth' });
        }

        function displayFullReport(analysis) {
            if (!analysis) return;

            // Display SHAPE scores
            document.getElementById('structuralScore').textContent = analysis.shapeScores.structural + '/5';
            document.getElementById('humanMeaningScore').textContent = analysis.shapeScores.humanMeaning + '/5';
            document.getElementById('authorialScore').textContent = analysis.shapeScores.authorial + '/5';
            document.getElementById('purposeScore').textContent = analysis.shapeScores.purpose + '/5';
            document.getElementById('editorialScore').textContent = analysis.shapeScores.editorial + '/5';
            document.getElementById('totalScore').textContent = analysis.totalShape + '/25';
            
            // Generate and display recommendations
            const recommendations = generateRecommendations(analysis);
            
            document.getElementById('strengths').textContent = recommendations.strengths;
            
            const opportunitiesList = document.getElementById('opportunities');
            opportunitiesList.innerHTML = '';
            recommendations.opportunities.forEach(opp => {
                const li = document.createElement('li');
                li.textContent = opp;
                opportunitiesList.appendChild(li);
            });
            
            const tacticsList = document.getElementById('tactics');
            tacticsList.innerHTML = '';
            recommendations.tactics.forEach(tactic => {
                const li = document.createElement('li');
                li.textContent = tactic;
                tacticsList.appendChild(li);
            });
            
            document.getElementById('nextFocus').textContent = recommendations.nextFocus;
            
            document.getElementById('fullReport').classList.remove('hidden');
        }

        function generateRecommendations(analysis) {
            const classification = analysis.classification;
            const scores = analysis.shapeScores;
            
            const recommendations = {
                strengths: "",
                opportunities: [],
                tactics: [],
                nextFocus: ""
            };

            // Generate classification-specific recommendations
            switch (classification) {
                case "Tool":
                    recommendations.strengths = "You're efficiently using AI for specific tasks. You understand how to get basic help from AI systems.";
                    recommendations.opportunities = [
                        "Ask for complete drafts instead of small pieces",
                        "Provide more context about your goals and audience",
                        "Try requesting multiple approaches to the same problem",
                        "Give AI more detailed instructions upfront"
                    ];
                    recommendations.tactics = [
                        "Start prompts with 'Create a complete...' instead of 'Help me with...'",
                        "Add context like 'This is for [audience] who needs [outcome]'",
                        "Ask 'What are 3 different ways to approach this problem?'",
                        "Try 'Act as a [expert role] and create...' to get specialized responses"
                    ];
                    recommendations.nextFocus = "Try one longer, more complex request instead of several short ones. Practice giving the AI more context and specific goals upfront.";
                    break;

                case "Assistant":
                    recommendations.strengths = "You're good at directing AI to create what you need. You provide clear instructions and get useful outputs.";
                    recommendations.opportunities = [
                        "Add more rounds of refinement after initial generation",
                        "Provide feedback on AI outputs to improve them",
                        "Ask the AI to critique or improve its own work",
                        "Guide the structure and organization more actively"
                    ];
                    recommendations.tactics = [
                        "After getting output, ask 'How could this be improved for my specific situation?'",
                        "Try 'What are the weaknesses in this approach?'",
                        "Use 'Please revise this with [specific improvement]'",
                        "Ask 'Reorganize this to better serve [specific audience]'"
                    ];
                    recommendations.nextFocus = "Focus on iterating and refining rather than just generating. Practice the back-and-forth conversation style to improve outputs.";
                    break;

                case "Augmentor":
                    recommendations.strengths = "You excel at improving and refining AI output. You understand the value of iteration and strategic collaboration.";
                    recommendations.opportunities = [
                        "Add more strategic direction upfront",
                        "Incorporate your unique perspective earlier in the process",
                        "Ask for alternative approaches before refining",
                        "Use AI as a thinking partner, not just a content generator"
                    ];
                    recommendations.tactics = [
                        "Start with 'Here's the bigger picture context...'",
                        "Ask 'What would [specific expert] say about this approach?'",
                        "Try 'Generate 3 different versions focusing on different aspects'",
                        "Use 'Challenge this assumption: [your assumption]'"
                    ];
                    recommendations.nextFocus = "Balance refinement with more upfront strategic input. Practice being the strategic leader of the collaboration.";
                    break;

                case "Cocreator":
                    recommendations.strengths = "You're leveraging AI as a true creative collaborator. You understand how to co-create and think strategically with AI.";
                    recommendations.opportunities = [
                        "Push for even more unconventional ideas",
                        "Use AI to stress-test your creative concepts",
                        "Explore cross-domain inspiration and analogies",
                        "Challenge AI to go beyond conventional responses"
                    ];
                    recommendations.tactics = [
                        "Ask 'What would this look like in a completely different industry?'",
                        "Try 'Generate the most unconventional solution you can think of'",
                        "Use 'What would [creative person] do differently here?'",
                        "Challenge with 'Push this idea to its extreme - what happens?'"
                    ];
                    recommendations.nextFocus = "Explore the edges of AI capability. Push for breakthrough thinking and novel connections between ideas.";
                    break;
            }

            // Add score-specific recommendations
            if (scores.structural < 3) {
                recommendations.opportunities.push("Work on providing more structural guidance and organization");
                recommendations.tactics.push("Ask for outlines before content: 'First create an outline for...'");
            }

            if (scores.humanMeaning < 3) {
                recommendations.opportunities.push("Add more context and interpretation to AI responses");
                recommendations.tactics.push("Follow up with 'What does this mean for my specific situation?'");
            }

            if (scores.authorial < 3) {
                recommendations.opportunities.push("Maintain more of your unique voice and perspective");
                recommendations.tactics.push("Request 'Write this in a style that sounds like [your description]'");
            }

            if (scores.purpose < 3) {
                recommendations.opportunities.push("Be more specific about goals, audience, and expected outcomes");
                recommendations.tactics.push("Always include: 'My audience is... and they need to...'");
            }

            if (scores.editorial < 3) {
                recommendations.opportunities.push("Practice more active editing and refinement");
                recommendations.tactics.push("After each response, ask 'What's missing from this?'");
            }

            return recommendations;
        }
    </script>
</body>
</html>